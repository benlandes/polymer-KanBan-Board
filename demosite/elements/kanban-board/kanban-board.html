<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-drag-drop/core-drag-drop.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../kanban-edit/kanban-edit.html">
<link rel="import" href="../kanban-create/kanban-create.html">

<polymer-element name="kanban-board">
  <template>
	<link rel="stylesheet" type="text/css" href="kanban-board.css">

	<paper-action-dialog autoCloseDisabled >
		<h1>KanBan Board</h1>
		<div class="create">
			<paper-button-base on-click="{{createStory}}">
				<core-icon icon="create"></core-icon>
				<kanban-create id="createStory" on-close="{{createDialogOnClose}}"></kanban-create>
			</paper-button-base>
		</div>
	
		<template repeat="{{epic in epicStoriesResponse.epics}}">
			<h2 class="boardTitle">{{epic.name}}</h2>
			<div class="board">
				<template repeat="{{state in epic.states}}">
					<div class="list" data-state="{{state.column}}" data-epic="{{epic.id}}">
						<h1>{{state.name}}</h1>
						<ol class="taskList" >
							<template repeat="{{story in state.stories}}">
								<li class="story" data-id="{{story.id}}">
									<core-drag-drop></core-drag-drop>
									<div class="status-{{story.status}}"></div>
									<div class="fab">
										<paper-button-base on-click="{{editStory}}">
											<core-icon icon="settings"></core-icon>
											<kanban-edit id="edit-{{story.id}}" storyID="{{story.id}}" on-close="{{editDialogOnClose}}"></kanban-edit>
										</paper-button-base>
										
									</div>
									<h2>{{story.summary}} - {{story.size}}</h2>
									<paper-progress value="{{story.percent_done}}"></paper-progress>
									
								</li>
							</template>
						</ol>
					</div>
				</template>
			</div>
		</template>
		
		<!-- Get Board -->
		<core-ajax
			  id = "getBoard"
			  auto
			  url="http://api.kanbanboard.local/stories.php"
			  response="{{epicStoriesResponse}}"
			  params='{"sprint_id":"a"}'
			  handleAs="json"
			  ></core-ajax>
		
		<!-- Update Story State -->
		<core-ajax
			  id = "updateStory"
			  method="PUT"
			  url="http://api.kanbanboard.local/stories.php"
			  params='{"id":"{{updateStoryID}}",
						"state":"{{updateStoryState}}",
						"epic_id":"{{updateStoryEpicID}}"}'
			  on-core-response="{{storyUpdated}}"
			  ></core-ajax>
	  

		</template>
		<paper-button affirmative>Cancel</paper-button>
		<paper-button affirmative autofocus>Accept</paper-button>
	</paper-action-dialog>
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script>
		function collectionHas(a, b) { //helper function (see below)
			for(var i = 0, len = a.length; i < len; i ++) {
				if(a[i] == b) return true;
			}
			return false;
		}
		function findParentBySelector(root,elm, selector) {
			var all = root.querySelectorAll(selector);
			var cur = elm.parentNode;
			while(cur && !collectionHas(all, cur)) { //keep going up until you find a match
				cur = cur.parentNode; //go up
			}
			return cur; //will return null if not found
		}
		function hasClass(element, cls) {
			return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
		}
		Polymer('kanban-board',{
			movingStoryHTML:null,
			root:null, //For storing shadowroot since events cannot access it through this.shadowRoot
			polymerElement:null,
			editDialogOnClose:function(){
				polymerElement.$.getBoard.go();
			},
			createDialogOnClose:function(){
				polymerElement.$.getBoard.go();
			},
			createStory:function(e){
				root.getElementById('createStory').showDialog();
			},
			editStory:function(e){
				console.log("Edit Story");
				/*var editElem = document.createElement('kanban-edit');
				
				var storyElem = findParentBySelector(root,e.target, ".story");
				editElem.setAttribute("storyID", storyElem.dataset.id);
				editElem.setAttribute("on-close", "{{editDialogOnClose}}");
				storyElem.appendChild(editElem);*/
				console.log(e.target);
				console.log(polymerElement.$.test);
				var storyElem = findParentBySelector(root,e.target, ".story");
				root.getElementById('edit-'+storyElem.dataset.id).showDialog();
				//polymerElement.$.test.showDialog();
			},
			ready:function(){
				//Track Start
				root = this.shadowRoot;
				polymerElement = this;
				
				//Create event listener for changing story state
				addEventListener('drag-start', function(e) {
				  var dragInfo = e.detail;
				  var movingElement = null;
				  if(hasClass(dragInfo.event.target,"story"))
				  {
					movingElement = dragInfo.event.target;
				  }
				  else
				  {
					movingElement = findParentBySelector(root,dragInfo.event.target, ".story");
				  }
				  
				  
				  polymerElement.updateStoryID = movingElement.dataset.id;
				  e.detail.avatar.innerHTML = "";
				  e.detail.avatar.appendChild(movingElement);
				  dragInfo.avatar.style.cssText = 'display:block; background-color:white; width:260px;';

				  
				  
				  dragInfo.drag = function() 
				  {
					console.log("Drag Continue");
				  };
				  dragInfo.drop = function(dragInfo) 
				  {
					console.log("Drag Stop");
					
					var dropTarget = dragInfo.event.relatedTarget;
					console.log(dropTarget);
					var stateList = findParentBySelector(root,dropTarget, ".list");
					if(hasClass(dropTarget,"list"))
					{
						stateList = dropTarget
					}
					
					//If dropped in state column update story
					if(stateList != null)
					{
						polymerElement.updateStoryState = stateList.dataset.state;
						polymerElement.updateStoryEpicID = stateList.dataset.epic;
						console.log(polymerElement.updateStoryID);
						console.log(polymerElement.updateStoryState);
						console.log(polymerElement.updateStoryEpicID);
						polymerElement.$.updateStory.go();
					}
					else
					{
						polymerElement.$.getBoard.go();
					}
					
				  };
				});

			},
			storyUpdated: function(event, response) {
				polymerElement.$.getBoard.go();
			},
			domReady:function(){
			
			}
		});


	</script>
</polymer-element>